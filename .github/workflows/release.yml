# Release Pipeline
#
# Prerequisites:
# 1. NPM_TOKEN secret: Create an npm automation token at https://www.npmjs.com/settings/YOUR_USERNAME/tokens
#    - Token type: "Automation" (for CI/CD) or "Publish" (legacy)
#    - Add to: https://github.com/hmake98/nestjs-mcp/settings/secrets/actions
#    - Secret name: NPM_TOKEN
# 2. GitHub Pages: Enable at https://github.com/hmake98/nestjs-mcp/settings/pages
#    - Source: "GitHub Actions"
#
# Triggers:
# - Manual: workflow_dispatch with version bump type (patch/minor/major)

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: "patch"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          npm version ${{ github.event.inputs.version }} -m "chore: release v%s"
          git push origin master --follow-tags

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Generate coverage badges
        run: npm run make-badges

      - name: Get version
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="v${{ steps.get-version.outputs.version }}"

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release"
            CHANGELOG="First release of nestjs-mcp"
          else
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save to file for GitHub release
          echo "$CHANGELOG" > CHANGELOG.txt

          echo "Changelog generated"

      - name: Verify NPM token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            echo "Please add your npm token to GitHub repository secrets:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: NPM_TOKEN"
            echo "4. Value: Your npm token (create one at https://www.npmjs.com/settings/YOUR_USERNAME/tokens)"
            echo "5. Make sure the token has 'Automation' or 'Publish' permissions"
            exit 1
          fi
          echo "NPM_TOKEN is configured"

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          name: Release v${{ steps.get-version.outputs.version }}
          body_path: CHANGELOG.txt
          draft: false
          prerelease: false
          files: |
            badges/*.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate documentation
        run: npm run docs:build

      - name: Upload documentation artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  deploy-docs:
    needs: release
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  post-release:
    needs: [release, deploy-docs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Notify release completion
        run: |
          echo "‚úÖ Release v${{ needs.release.outputs.version }} completed successfully!"
          echo "üì¶ Package published to npm: https://www.npmjs.com/package/@nestjs-mcp/server"
          echo "üìö Documentation deployed to GitHub Pages"
          echo "üè∑Ô∏è GitHub release created: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release.outputs.version }}"
